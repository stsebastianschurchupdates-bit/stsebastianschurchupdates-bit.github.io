<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnehaNidhi Winner App</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="main-container" class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-2xl text-center transition-all duration-300">
        <h1 class="text-3xl font-extrabold text-indigo-800 mb-6">SnehaNidhi Winners</h1>

        <!-- Authentication and Action Section -->
        <div id="auth-action-section" class="flex flex-col items-center justify-center space-y-4 mb-8">
            <div id="user-info-display" class="hidden">
                <p class="text-lg text-gray-700 font-semibold">Welcome, <span id="user-name" class="text-indigo-600"></span>!</p>
            </div>
            
            <!-- This button now handles both sign-in and winner generation -->
            <button id="main-action-btn" class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-green-600 transition-colors duration-300 flex items-center justify-center space-x-2">
                <span>Generate Winner</span>
            </button>
            
            <button id="sign-out-btn" class="hidden bg-red-500 text-white font-bold py-2 px-4 rounded-full shadow-lg hover:bg-red-600 transition-colors duration-300">
                Sign Out
            </button>
        </div>

        <!-- Main App Section -->
        <div id="app-content" class="hidden space-y-6">
            <h2 id="winner-heading" class="text-2xl font-bold text-gray-700"></h2>
            <div id="winner-display" class="bg-green-100 border-2 border-green-500 rounded-xl p-6 text-center shadow-inner">
                <span id="winning-number" class="text-5xl font-extrabold text-green-700">---</span>
            </div>

            <h3 class="text-xl font-bold text-gray-700 mt-8">Previous Winners</h3>
            <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 shadow-inner overflow-x-auto">
                <table id="winners-table" class="min-w-full text-left text-sm font-light">
                    <thead class="border-b font-medium dark:border-neutral-500">
                        <tr>
                            <th scope="col" class="px-6 py-4">S.No.</th>
                            <th scope="col" class="px-6 py-4">Draw Date</th>
                            <th scope="col" class="px-6 py-4">Winning Number</th>
                        </tr>
                    </thead>
                    <tbody id="winners-tbody">
                        <!-- Winner rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your Firebase configuration provided by the user
        const firebaseConfig = {
            apiKey: "AIzaSyCcuFTwygQ5-KujxUdv45b2TPY5yQXVVTo",
            authDomain: "snehanidhi-74ff0.firebaseapp.com",
            projectId: "snehanidhi-74ff0",
            storageBucket: "snehanidhi-74ff0.firebasestorage.app",
            messagingSenderId: "726238156431",
            appId: "1:72623156431:web:e60b0b5ed66f2d628342fa",
            measurementId: "G-7ZW0ZSQGLZ"
        };
        
        // Use the project ID from your config for the collection path
        const appId = firebaseConfig.projectId;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // DOM elements
        const mainActionBtn = document.getElementById('main-action-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userInfoDisplay = document.getElementById('user-info-display');
        const userNameSpan = document.getElementById('user-name');
        const appContent = document.getElementById('app-content');
        const winnerHeading = document.getElementById('winner-heading');
        const winningNumberSpan = document.getElementById('winning-number');
        const winnersTbody = document.getElementById('winners-tbody');

        // Functions
        async function signInWithGoogle() {
            try {
                // Return the promise from signInWithPopup so we can chain .then()
                return await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error during Google sign-in:", error);
                return null;
            }
        }

        async function signOutGoogle() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error during sign out:", error);
            }
        }

        function generateWinningNumber() {
            // Generate a random 4-digit number
            const number = Math.floor(1000 + Math.random() * 9000);
            return number;
        }

        async function saveWinner(userId, winnerData) {
            const winnersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/winners`);
            // Use addDoc to create a new document with an auto-generated ID
            await addDoc(winnersCollectionRef, winnerData);
        }

        async function handleWinnerGeneration() {
            const user = auth.currentUser;
            if (user) {
                const winningNumber = generateWinningNumber();
                const currentDate = new Date();
                const monthAndYear = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                
                // Construct the winner data object
                const winnerData = {
                    number: winningNumber,
                    date: serverTimestamp(),
                    monthAndYear: monthAndYear
                };
                
                // Save the winner data to Firestore under the user's ID
                await saveWinner(user.uid, winnerData);
                
                // Update the UI with the generated number
                winningNumberSpan.textContent = winningNumber;
            }
        }

        // Event listener for the main action button
        mainActionBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user) {
                // User is already logged in, so proceed to generate winner
                await handleWinnerGeneration();
            } else {
                // User is not logged in, trigger Google Sign-in
                await signInWithGoogle();
                // onAuthStateChanged listener will handle UI update after login
            }
        });

        signOutBtn.addEventListener('click', signOutGoogle);

        // Authentication state observer
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                console.log("User signed in:", user.uid);
                userInfoDisplay.classList.remove('hidden');
                signOutBtn.classList.remove('hidden');
                appContent.classList.remove('hidden');
                mainActionBtn.textContent = 'Generate Winner';
                
                // Display the user's name
                userNameSpan.textContent = user.displayName || user.email;

                // Set up real-time listener for winners data for the current user
                const winnersCollectionRef = collection(db, `artifacts/${appId}/users/${user.uid}/winners`);
                const q = query(winnersCollectionRef);

                onSnapshot(q, (snapshot) => {
                    const winners = [];
                    snapshot.forEach(doc => {
                        const winner = doc.data();
                        winners.push({
                            id: doc.id,
                            ...winner
                        });
                    });
                    
                    // Sort the winners by date in descending order
                    winners.sort((a, b) => b.date - a.date);

                    // Render the winners table
                    winnersTbody.innerHTML = '';
                    winners.forEach((winner, index) => {
                        const date = winner.date ? winner.date.toDate().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
                        const row = `
                            <tr class="border-b dark:border-neutral-500">
                                <td class="whitespace-nowrap px-6 py-4 font-medium">${index + 1}</td>
                                <td class="whitespace-nowrap px-6 py-4">${date}</td>
                                <td class="whitespace-nowrap px-6 py-4">${winner.number}</td>
                            </tr>
                        `;
                        winnersTbody.innerHTML += row;

                        // Update the latest winner heading if it's the first one in the sorted list
                        if (index === 0) {
                            winnerHeading.textContent = `${winner.monthAndYear || 'Latest'} Winning Number`;
                            winningNumberSpan.textContent = winner.number;
                        }
                    });
                }, (error) => {
                    console.error("Error getting winners data:", error);
                });

            } else {
                // User is signed out
                console.log("User signed out.");
                userInfoDisplay.classList.add('hidden');
                signOutBtn.classList.add('hidden');
                appContent.classList.add('hidden');
                mainActionBtn.innerHTML = `
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512">
                        <path fill="currentColor" d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C293.9 124.2 271.6 112 248 112c-61.1 0-111.3 43.2-123.3 100.8H248v72H113.6c2.3 12.7 5.6 24.9 9.9 36.8h1.1l7.5 20.6c7.7 21.6 20.2 41 36.5 57.3C185.3 402.1 215.3 416 248 416c41.1 0 77.8-19.6 102.6-52.5l-33.1-32.5c-15.5 22.8-37.1 36.6-62.5 36.6-47.5 0-85.9-40.2-85.9-89.9s38.4-89.9 85.9-89.9c32.7 0 60.1 18.1 76.5 45.4l33.1-32.5c-25.3-22.8-57.9-36.6-94.6-36.6-66.8 0-123.6 24.5-166.3 64.9C10.7 131.9 0 181.9 0 256s110.8 248 248 248c66.8 0 123-24.5 166.3-64.9L488 261.8z"/>
                    </svg>
                    <span>Sign in with Google to Continue</span>
                `;
                
                // Clear the winners table
                winnersTbody.innerHTML = '';
                winnerHeading.textContent = 'Winning Number';
                winningNumberSpan.textContent = '---';
            }
        });

    </script>
</body>
</html>

